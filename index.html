<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        if ("object" !== typeof global) {
    global = "object" === typeof window ? window : globalThis
}
Object.getByIndex = function (e, i) {
    if ("number" !== typeof i) {
        i = 0
    }
    for (var key in e) {
        if (e.hasOwnProperty(key)) {
            if (i <= 0) {
                return key
                break;
            }
            i -= 1
        }
    }
}

window.exe = {
    cores: {
        global: global,
        $: function () {
            if ((arguments[0] instanceof Object) === false&&"string" !== typeof arguments[0]) {
                return
            }
            for (var i = 1; i < arguments.length; i++) {
                if ("number" === typeof arguments[i]) {
                    arguments[i] = String(arguments[i])
                }
                if ("string" === typeof arguments[i]) {
                    if ("string" === typeof arguments[i + 1]) {
                        if (arguments[i + 1].trim() === "=") {
                            return arguments[0][arguments[i]] = arguments[i + 2]
                        } else if (arguments[i + 1].trim() === "+=") {
                            return arguments[0][arguments[i]] += arguments[i + 2]
                        } else {
                            arguments[0] = arguments[0][arguments[i]]
                        }
                    } else if (arguments[i + 1] instanceof Array) {
                        if ("function" === typeof arguments[0][arguments[i]]) {
                            var s = "";
                            for (var _i = 0; _i < arguments[i + 1].length; _i++) {
                                s += 'arguments[i+1][' + _i + ']'
                                if (arguments[i + 1].length > _i + 1) {
                                    s += ','
                                }
                            }
                            arguments[0] = eval('arguments[0][arguments[i]](' + s + ')')
                        } else {
                            return
                        }
                        i = i + 1
                    } else {
                        arguments[0] = arguments[0][arguments[i]]
                    }
                } else if (arguments[i] instanceof Array) {
                    if ("function" === typeof arguments[0]) {
                        var s = "";
                        for (var _i = 0; _i < arguments[i].length; _i++) {
                            s += 'arguments[i][' + _i + ']'
                            if (arguments[i].length > _i + 1) {
                                s += ','
                            }
                        }
                        var _p = arguments[0]
                        arguments[0] = eval('_p(' + s + ')')
                        _p = null
                    } else {
                        return
                    }
                }
                if (arguments[0] === null || arguments[0] === undefined) {
                    break;
                }
            }
            return arguments[0]
        },
        // delay : global.setImmediate||global.setTimeout,
        syncLoop: function () {
            var foo = new Function(),
                obj;
            for (var i = 0; i < arguments.length; i++) {
                if ("function" === typeof arguments[i]) {
                    foo = arguments[i]
                } else if ("object" === typeof arguments[i] || "string" === typeof arguments[i]) {
                    obj = arguments[i]
                }
            }

            var i = {
                index: 0,
                length: obj ? obj.length : null,
                get key() {
                    if (obj) {
                        if (obj instanceof Array || "string" === typeof obj || ("function" === typeof NodeList && obj instanceof NodeList)) {
                            return i.index
                        } else {
                            return Object.getByIndex(obj, i.index)
                        }
                    } else {
                        return i.index
                    }
                },
                get done() {
                    if (obj) {
                        return !(obj.hasOwnProperty(i.key))
                    } else {
                        return 1
                    }
                }
            }

            var r = function () {
                i.index += 1
                if (!i.done) {
                    foo({
                        key: i.key,
                        done: i.done,
                        length: i.length,
                        value: obj[i.key]
                    }, r)
                } else {
                    foo({
                        key: i.key,
                        length: i.length,
                        done: i.done
                    }, r)
                }
            }

            if (!i.done) {
                foo({
                    key: i.key,
                    done: i.done,
                    length: i.length,
                    value: obj[i.key]
                }, r)
            } else {
                foo({
                    key: i.key,
                    length: i.length,
                    done: i.done
                }, r)
            }
        },
        fetch: function (url, opt) {
            opt = opt || {}
            if (!opt.__proto__.init) {
                opt.__proto__ = {
                    method: 'GET',
                    type: 'text',
                    headers: {},
                    init: 1
                }
            }
            if (opt.updateCache) {
                return new exe.Faker.Promise(function (r) {
                    xhttpCacheStorage.setItem(url, {
                        type: null,
                        response: opt.newCache
                    }).then(r)
                })
            }
            if (opt.cache) {
                opt.__proto__.cacheKey = encodeURIComponent(url)
                opt.__proto__.cacheInterval = Number(opt.cacheInterval) || 0
            }

            var xhttp = new XMLHttpRequest();
            xhttp.responseType = opt.type.toLowerCase();


            xhttp.open(opt.method, url, true);
            for (var key in opt.headers) {
                if (opt.headers.hasOwnProperty(key)) {
                    xhttp.setRequestHeader(key, opt.headers[key])
                }
            }
            try {
                if (opt.body instanceof Object) {
                    xhttp.send(JSON.stringify(opt.body))
                } else {
                    xhttp.send()
                }
            } catch (e) {}
            if (opt.nullResponse) {
                return new exe.Faker.Promise(function (r, j) {
                    xhttp.onerror = j
                    xhttp.onreadystatechange = function (e) {
                        if (!xhttp.status && xhttp.readyState > xhttp.HEADERS_RECEIVED) {
                            xhttp.onreadystatechange = null
                            return;
                        }
                        // console.log(arguments[0].target);
                        r({
                            options: Object.freeze(opt),
                            status: arguments[0].target.status,
                            // _status:arguments[0].target.status < 200?200:arguments[0].target.status,
                            statusText: arguments[0].target.statusText,
                            header: new (function (e) {
                                this.get = function(){
                                    if ("string" !== typeof arguments[0]) {
                                        arguments[0]=String(arguments[0])
                                    }
                                    arguments[0]+=":"
                                    arguments[0]=arguments[0].replace(/\W/img,'\\$&');
                                    // d.match(new RegExp(`${"content-type:".replace(/\W/img,'\\$&')}\\s([^\\n$]+)`,'i'))
                                    arguments[0]=e.match(new RegExp(`${arguments[0]}\\s([^\\n$]+)`,'i'))
                                    if (arguments[0]&&"string" === typeof arguments[0][1]) {
                                        return arguments[0][1]
                                    }
                                }
                                this.has = function(){
                                    return e.include(arguments[0]+":")
                                }
                                
                            })(xhttp.getAllResponseHeaders()),
                            body: null,
                            ok: arguments[0].target.status < 300,
                            url: arguments[0].target.responseURL,
                            xhttp: opt.direct ? xhttp : null
                        })
                        xhttp.abort()
                    }
                })
            }

            return new exe.Faker.Promise(function (r, j) {
                //cache
                if (opt.cache && opt.returnCache !== 0) {
                    var _r = r
                    var _j = new Function()
                    _j.j = j
                    // if (localStorage["nimo-xhttp-"+opt.cacheKey]) {
                    xhttpCacheStorage.getItem(opt.cacheKey).then(function () {
                        if (!arguments[0]) {
                            if (opt.returnCache) {
                                opt.returnCache = 0
                                exe.cores.fetch(url, opt).then(_r).catch(_j.j)
                            } else {
                                _j("unknown value")
                            }
                            return;
                            // return !opt.returnCache||(opt.returnCache=0)||exe.cores.fetch(url,opt).then(r)
                        }
                        if ("string" === typeof arguments[0].type) {
                            if (arguments[0].type === "Document") {
                                arguments[0].type = new Document()
                                arguments[0].n = document.createElement("html");
                                arguments[0].n.innerHTML = arguments[0].response || ""
                                arguments[0].type.appendChild(arguments[0].n)
                                _r(arguments[0].type)
                                delete arguments[0].type
                                delete arguments[0].n
                            } else {
                                _j("unknown type")
                            }
                        } else {
                            _r(arguments[0].response)
                        }
                        delete arguments[0].response
                    });
                    if (opt.returnCache) {
                        r = new Function()
                        j = new Function()
                        //return
                    }
                    // }
                }

                if ("function" === typeof opt.onerror) {
                    xhttp.onerror = function () {
                        opt.onerror(url,r,j)
                    }
                }else if (opt.onerror ===true) {
                    xhttp.onerror = function () {
                        j()
                    }
                }
                
                xhttp[xhttp.onloadend ? 'onloadend' : 'onload'] = function () {
                    // "use strict"
                    xhttp.ok = xhttp.status < 300
                    // const ok=xhttp.ok
                    // const status=xhttp.status
                    // const window=null
                    // const document=null
                    // const location=null
                    // const localStorage=null
                    // console.log(opt.returnCache,exe.cores.fetch.eval(opt.returnCache));
                    if ("object" === typeof opt.conditions) {
                        for (var key in opt.conditions) {
                            if (!(xhttp[key] === opt.conditions[key])) {
                                j("conditions not match")
                                return
                            }
                        }
                    }
                    //fixed here (fell asleep while debuging if condition)
                    if (opt.cache && "string" === typeof opt.returnCache ? opt.returnCache !== "NULL" : true) {
                        new exe.Faker.Promise(function (r, j) {
                            if (xhttp.response instanceof Document) {
                                if (xhttp.response.documentElement) {
                                    xhttpCacheStorage.setItem(opt.cacheKey, {
                                        type: "Document",
                                        response: xhttp.response.documentElement.innerHTML
                                    }).then(r)
                                } else {
                                    xhttpCacheStorage.setItem(opt.cacheKey, {
                                        type: "Document",
                                        response: ""
                                    }).then(r)
                                }
                            } else {
                                xhttpCacheStorage.setItem(opt.cacheKey, {
                                    type: null,
                                    response: xhttp.response
                                }).then(r)
                            }
                        })
                        // .then(function(){
                        //     localStorage["nimo-xhttp-"+opt.cacheKey]=1
                        // });
                    }
                    if (opt.direct) {
                        xhttp = xhttp.response
                    }
                    r(xhttp)
                };
            })
        },
        event: function (type, data, onInit, executeParent) {
            var EventData = function () {
                this.value = arguments[0]
                this.childData = {}
            }
            if (type instanceof Array === false) {
                type = (type + "").split(/\\|\//img)
            }
            // console.trace(type);
            // type=array
            if ("object" !== typeof arguments.callee.store || !(arguments.callee.store instanceof Object)) {
                arguments.callee.store = {}
            }
            var store = arguments.callee.store,
                childEvents = [];
            for (var i = 1; i < type.length; i++) {
                store = store[type[i]] || {}
            }
            store.data = store.data || data || {};
            store.events = store.events || {};
            if (!store.eventhandler) {
                store.eventhandler = {}
            }
            i = i - 1
            return store.eventhandler[type[i]] = store.eventhandler[type[i]] || {
                has: function (name) {
                    if (name instanceof Array === false) {
                        name = (name + "").split(/\\|\//img)
                    }
                    var _store = store.events
                    for (var i = 0; i < name.length; i++) {
                        if ("string" !== typeof name[i]) {
                            name[i] = Sting(name[i])
                        }
                        if (name[i].trim() === "" && (_store instanceof Object) && i + 1 >= name.length) {
                       console.log(_store);
                            return Object.keys(_store).length > 0
                        } else {
                            _store = _store[name[i]]
                            if ((_store instanceof Array) === false) {
                                return false;
                            }
                            if (name.length > i + 1) {
                                _store = _store.childEvents
                            }
                        }
                    }
                    return ((_store instanceof Array)&&_store.length>0)
                },
                emit: function (name, data) {
                    if (name instanceof Array === false) {
                        name = (name + "").split(/\\|\//img)
                    }
                    var _store = store.events
                    for (var i = 0; i < name.length; i++) {
                        if ("string" !== typeof name[i]) {
                            name[i] = Sting(name[i])
                        }
                        if (name[i] === "") {
                            return
                        }
                        if ((_store[name[i]] instanceof Array) === false) {
                            _store[name[i]] = new Array()
                            _store[name[i]].childEvents = {}
                        }
                        _store = _store[name[i]]
                        if (i + 1 >= name.length) {
                            _store.data = data
                            for (var _i = 0; _i < _store.length; _i++) {
                                if ("function" === typeof _store[_i]) {
                                    _store[_i](_store.data)
                                }
                            }
                            if (!_store.emited) {
                                _store.emited = true
                            }
                        } else {
                            if (!executeParent) {
                                for (var _i = 0; _i < _store.length; _i++) {
                                    if ("function" === typeof _store[_i]) {
                                        _store[i]()
                                    }
                                }
                            }
                            _store = _store.childEvents
                        }
                    }
                },
                on: function (name, foo, index) {
                    if (name instanceof Array === false) {
                        name = (name + "").split(/\\|\//img)
                    }
                    var _store = store.events
                    for (var i = 0; i < name.length; i++) {
                        if ("string" !== typeof name[i]) {
                            name[i] = Sting(name[i])
                        }
                        if (name[i] === "") {
                            return
                        }
                        if ((_store[name[i]] instanceof Array) === false) {
                            _store[name[i]] = new Array()
                            _store[name[i]].childEvents = {}
                        }
                        _store = _store[name[i]]
                        if (name.length <= i + 1) {
                            if ("function" === typeof foo) {
                                if (!onInit && _store.emited) {
                                    foo(_store.data)
                                }
                                if (index && _store.length > index) {
                                    _store[index] = foo
                                } else {
                                    _store.push(foo)
                                }
                                return _store.length - 1
                            }
                        } else {
                            if (i + 1 < name.length) {
                                _store = _store.childEvents
                            }
                        }
                    }
                },
                get: function (name) {
                    if (name instanceof Array === false) {
                        name = (name + "").split(/\\|\//img)
                    }
                    var _store = store.events
                    for (var i = 0; i < name.length; i++) {
                        if ("string" !== typeof name[i]) {
                            name[i] = Sting(name[i])
                        }
                        _store = _store[name[i]]
                        if (!_store) {
                            break;
                        }
                        if (name.length <= i + 1) {
                            return _store.data
                        } else {
                            if (i + 1 < name.length) {
                                _store = _store.childEvents
                            }
                        }
                    }

                    return null
                },
                clearEvent: function (name, index) {
                    if (name instanceof Array === false) {
                        name = (name + "").split(/\\|\//img)
                    }
                    var _store = store.events
                    for (var i = 0; i < name.length; i++) {
                        if ("string" !== typeof name[i]) {
                            name[i] = Sting(name[i])
                        }
                        _store = _store[name[i]]
                        if (!_store) {
                            break;
                        }
                        if (name.length <= i + 1) {
                            if (index < _store.length) {
                                _store[index] = null
                                return true
                            } else {
                                break
                            }
                        } else {
                            if (i + 1 < name.length) {
                                _store = _store.childEvents
                            }
                        }
                    }
                    return false
                },
                clearAllEvents: function (name) {
                    if (name instanceof Array === false) {
                        name = (name + "").split(/\\|\//img)
                    }
                    var _store = store.events
                    for (var i = 0; i < name.length; i++) {
                        if ("string" !== typeof name[i]) {
                            name[i] = Sting(name[i])
                        }
                        _store = _store[name[i]]
                        if (!_store) {
                            break;
                        }
                        if (name.length <= i + 1) {
                            _store.length = 0
                            return true
                        } else {
                            if (i + 1 < name.length) {
                                _store = _store.childEvents
                            }
                        }
                    }
                    return false
                },
                appendChildEvent: function (_type, data, _1, _2, _3) {
                    return childEvents[childEvents.push(exe.cores.event(type.push(_type) ? type : type, data, _1, _2, _3)) - 1]
                },
                get name() {
                    return [String(type), type]
                },
                get childEvents() {
                    return childEvents
                },
                get NEST_SIZE() {
                    return i
                }
            };
        }
    },

    fetch: function (url, opt) {
        if (!(opt instanceof Object)) {
            opt = {}
        }
        opt.nullResponse = 1
        return new exe.Faker.Promise(function (r) {
            exe.cores.fetch(url, opt).then(function () {
                url = arguments[0].url
                opt = {}
                opt.nullResponse = 0
                opt.__proto__ = arguments[0].opt
                arguments[0].__proto__ = {
                    xml: function () {
                        return new exe.Faker.Promise(function (r, j) {
                            opt.type = 'document'
                            opt.direct = 1
                            exe.cores.fetch(url, opt).then(function () {
                                if (arguments[0] instanceof Object) {
                                    r(arguments[0])
                                } else {
                                    j("error in xml")
                                }
                            });
                        })
                    },
                    arrayBuffer: function () {
                        return new exe.Faker.Promise(function (r, j) {
                            opt.type = 'arrayBuffer'
                            opt.direct = 1
                            exe.cores.fetch(url, opt).then(function () {
                                if (arguments[0] instanceof Object) {
                                    r(arguments[0])
                                } else {
                                    j("error in arrayBuffer")
                                }
                            });
                        })
                    },
                    blob: function () {
                        return new exe.Faker.Promise(function (r, j) {
                            opt.type = 'blob'
                            opt.direct = 1
                            exe.cores.fetch(url, opt).then(function () {
                                if (arguments[0] instanceof Object) {
                                    r(arguments[0])
                                } else {
                                    j("error in blob")
                                }
                            });
                        })
                    },
                    json: function () {
                        return new exe.Faker.Promise(function (r, j) {
                            opt.type = 'json'
                            opt.direct = 1
                            exe.cores.fetch(url, opt).then(function () {
                                if (arguments[0] instanceof Object) {
                                    r(arguments[0])
                                } else {
                                    j("error in JSON")
                                }
                            });
                        })
                    },
                    text: function () {
                        return new exe.Faker.Promise(function (r, j) {
                            opt.type = 'text'
                            opt.direct = 1
                            exe.cores.fetch(url, opt).then(function () {
                                r(arguments[0])
                            });
                        })
                    }
                }
                r(arguments[0])
            });
        })
    },
    Faker: {
        Promise: function (foo, delay) {
            if ("function" !== typeof foo) {
                foo = new Function()
            }
            "use strict";
            var value = {
                    catch: {},
                    then: {}
                },
                resolved;
            try {
                foo(function (e) {
                    // console.log(e);
                    if (resolved) {
                        return
                    }
                    if (delay) {
                        (exe.cores.global.setTimeout || exe.cores.global.setImmediate || exe.cores.global.requestAnimationFrame || exe.cores.global.setTimeout)(function () {
                            resolved = true
                            if ("function" === typeof value.then.foo) {
                                value.then.foo(e)
                            }
                            value.then.foo = e
                        }, 0);
                        return
                    }
                    //   arguments.callee.done=
                    resolved = true
                    if ("function" === typeof value.then.foo) {
                        value.then.foo(e)
                    }
                    value.then.foo = e
                }, function (e) {
                    if (resolved) {
                        return
                    }
                    if (delay) {
                        (exe.cores.global.setTimeout || exe.cores.global.setImmediate || exe.cores.global.requestAnimationFrame || exe.cores.global.setTimeout)(function () {
                            // arguments.callee.done=
                            resolved = true;
                            if ("function" === typeof value.catch.foo) {
                                value.catch.foo(e)
                            }
                            value.catch.foo = e
                            setTimeout(function () {
                                if (!value.catch.called) {
                                    console.error(new Error(e))
                                }
                            }, 500);
                        }, 0);
                        return
                    }
                    // arguments.callee.done=
                    resolved = true;
                    if ("function" === typeof value.catch.foo) {
                        value.catch.foo(e)
                    }
                    value.catch.foo = e
                    setTimeout(function () {
                        if (!value.catch.called) {
                            console.error(new Error(e))
                        }
                    }, 500);
                })
            } catch (error) {
                if (!resolved) {
                    resolved = true
                    if ("function" === typeof value.catch.foo) {
                        value.catch.foo(error)
                    }
                    value.catch.foo = error
                    setTimeout(function () {
                        if (!value.catch.called) {
                            console.error(new Error(error))
                        }
                    }, 500);
                }
            }
            this.then = function (foo) {
                if (value.then.hasOwnProperty("foo") && "function" !== typeof value.then.foo) {
                    foo(value.then.foo)
                } else {
                    value.then.foo = foo
                }
                return this
            }
            this.catch = function (foo) {
                if ("number" === typeof value.catch.called) {
                    value.catch.called += 1
                } else {
                    value.catch.called = 1
                }
                if (value.catch.hasOwnProperty("foo") && "function" !== typeof value.catch.foo) {
                    foo(value.catch.foo)
                } else {
                    value.catch.foo = foo
                }
                return this
            }
        }
    },

}
exe.cores.fetch.eval = function () {
    if ("string" !== typeof arguments[0]) {
        return
    }
    return
    arguments[0] = arguments[0].split(/\w+\s+\W+\s\W/)
    LOG("exe.cores.fetch.eval is still in progress(not yet completed)")
}
exe.event = exe.cores.event(['page'], undefined, 1, 1)
if ("function" !== typeof window.fetch) {
    window.fetch = exe.fetch
}

    </script>
    <script src="script.js"></script>
    <script>
        addEventListener("load",function(){
            console.log('window');
        })

        document.addEventListener("load",function(){
            console.log('doc');
        })
        // new Function(`
        // console.log(arguments[0])
        // `)({a:9})
        // console.log(eval(`console.log(2)`))
// var obj ={
// a:1,
// b:2
// }
// ;
// "use strict"
// with(obj){
//     console.log(a+b,window.a);
// }
// var arguments=888
// console.log(arguments);

// ;
// (function(e){
    
//     arguments=undefined;
//     {
// "use strict"
//         const arguments=0
// console.log(arguments)
// }
// })(2);
// addEventListenera=addEventListener
// addEventListenera("load",function(){
//     console.log(8888);
// })

    </script>
</head>
<body>
    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Soluta similique nesciunt, magni corrupti dolores repudiandae dicta quisquam accusantium recusandae est asperiores unde rerum esse sunt adipisci explicabo? Unde, porro eligendi.</p>
</body>
</html>